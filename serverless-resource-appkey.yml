Type: AWS::KMS::Key
DependsOn: IamRoleLambdaExecution
Properties:
  Description: 'Key used to encrypt secrets for this stage'
  Enabled: true
  EnableKeyRotation: true
  KeyPolicy:
    Version: '2012-10-17'
    Statement:
      - Sid: Allow administration of the key by GS-FullAdmin
        Effect: Allow
        Principal:
          AWS:
            Fn::Join:
              - ''
              - - 'arn:aws:iam::'
                - Ref: AWS::AccountId
                - ':role/GS-FullAdmin'
        Action:
          - kms:*
        Resource: '*'
      - Sid: Allow admin by CodeBuild service role defined in gs.aws.pipelines security directory
        Effect: Allow
        Principal:
          AWS:
            Fn::ImportValue: codebuild-arn-${self:service}-${self:provider.stage}
        Action:
          - kms:*
        Resource: '*'
      - Sid: ${self:service} ${self:provider.stage} Allow Key usage to Lambda Execution Role
        Effect: Allow
        Principal:
          AWS:
            Fn::GetAtt: [ IamRoleLambdaExecution, Arn ]
        Action:
          - kms:Encrypt
          - kms:Decrypt
          - kms:ReEncrypt*
          - kms:GenerateDataKey*
          - kms:DescribeKey
        Resource: '*'
      - Sid: Allow everyone to encrypt
        Effect: Allow
        Principal:
          AWS: "*"
        Action:
          - kms:Encrypt
          - kms:GenerateDataKey
        Resource: "*"
