Type: AWS::S3::BucketPolicy
DependsOn: IamRoleLambdaExecution
Properties:
  Bucket:
    Ref: SecretsBucket
  PolicyDocument:
    Version: '2012-10-17'
    Statement:
      - Sid: Allow admins to upload encrypted secrets using stack key
        Action:
          - s3:PutObject
        Effect: Allow
        Principal:
          AWS:
            Fn::Join:
              - ''
              - - 'arn:aws:iam::'
                - Ref: AWS::AccountId
                - ':role/GS-FullAdmin'
        Resource:
          Fn::Join:
            - ''
            - - 'arn:aws:s3:::'
              - Ref: SecretsBucket
              - '/*'
        Condition:
          StringEquals:
            s3:x-amz-server-side-encryption: aws:kms
            s3:x-amz-server-side-encryption-aws-kms-key-id:
              Fn::GetAtt: [ AppKey, Arn ]
          Bool:
            aws:SecureTransport: true
      - Sid: Do not allow other keys to be used in this bucket
        Effect: Deny
        Principal: '*'
        Action:
          - s3:PutObject
        Resource:
          Fn::Join:
            - ''
            - - 'arn:aws:s3:::'
              - Ref: SecretsBucket
              - '/*'
        Condition:
          StringNotEquals:
            s3:x-amz-server-side-encryption-aws-kms-key-id:
              Fn::GetAtt: [ AppKey, Arn ]
      - Sid: Allow Lambda execution role to download and decrypt secrets
        Effect: Allow
        Action:
          - s3:GetObject
        Principal:
          AWS:
            Fn::GetAtt: [ IamRoleLambdaExecution, Arn ]
        Resource:
          Fn::Join:
            - ''
            - - 'arn:aws:s3:::'
              - Ref: SecretsBucket
              - '/*'
        Condition:
            Bool:
              aws:SecureTransport: true
      - Sid: Allow CodeBuild app execution role to download and decrypt secrets
        Effect: Allow
        Action:
          - s3:GetObject
        Principal:
          AWS:
            Fn::ImportValue: codebuild-arn-${self:service}-${self:provider.stage}
        Resource:
          Fn::Join:
            - ''
            - - 'arn:aws:s3:::'
              - Ref: SecretsBucket
              - '/*'
        Condition:
          Bool:
            aws:SecureTransport: true
